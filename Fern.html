<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mein TV-Programm v3 — Groß & Smart</title>
<style>
:root{--bg:#04060a;--card:#0f1318;--muted:#9aa6b2;--accent:#e50914}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#030409,#071018);color:#e8eef6}
.app{max-width:1200px;margin:14px auto;padding:16px}
.header{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#0b1220,#151923);display:flex;align-items:center;justify-content:center;font-weight:800}
.title{font-size:20px;margin:0}
.subtitle{color:var(--muted);font-size:13px}
.controls{margin-left:auto;display:flex;gap:8px}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:inherit;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),#ff6b6b);border:none;color:white}
.layout{display:grid;grid-template-columns:1fr 420px;gap:14px;margin-top:14px}
.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 22px rgba(0,0,0,.6)}
.timeline{display:flex;gap:8px;overflow:auto;padding:8px 4px;border-radius:10px;margin-bottom:12px}
.timecell{min-width:88px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);text-align:center;font-weight:700}
.row{margin-bottom:12px}
.row-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.row-title{font-weight:800}
.row-scroll{display:flex;gap:10px;overflow:auto;padding-bottom:8px}
.card{min-width:170px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
.poster{width:160px;height:90px;border-radius:6px;background:#061018;margin-bottom:8px;background-size:cover;background-position:center}
.meta{display:flex;flex-direction:column;gap:6px}
.titleSmall{font-weight:700}
.provider{font-size:12px;color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.footer-note{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}

/* modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,12,0.6);z-index:60}
.modal.open{display:flex}
.modal-card{width:92%;max-width:880px;background:var(--card);padding:16px;border-radius:12px}
.modal-top{display:flex;gap:12px}
.modal-poster{width:200px;height:300px;border-radius:6px;background:#051018;background-size:cover;background-position:center}
.modal-body{flex:1}
.modal-title{font-size:18px;font-weight:800}
.modal-desc{color:var(--muted);margin-top:8px}
.modal-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

@media(max-width:900px){.layout{grid-template-columns:1fr}.modal-top{flex-direction:column}.modal-poster{width:100%;height:220px}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">TV</div>
    <div>
      <h1 class="title">Mein TV-Programm v3 — Groß & Smart</h1>
      <div class="subtitle">16:00–02:00 • echte Laufzeiten (aufgerundet) • 6 Sender • großer, realistischer Pool</div>
    </div>
    <div class="controls">
      <button class="btn" id="regen">Neu generieren</button>
      <button class="btn" id="export">Als Datei speichern</button>
      <button class="btn primary" id="settingsBtn">Einstellungen</button>
    </div>
  </div>

  <div class="layout">
    <div>
      <div class="panel" id="mainPanel">
        <div id="timeline" class="timeline"></div>
        <div id="rows"></div>
      </div>
    </div>

    <aside class="aside">
      <div class="panel">
        <div class="small">Quellen: Netflix DE · Prime Video DE · Sky Go / WOW · ARD Mediathek · ZDF · ARTE</div>
        <div style="height:8px"></div>
        <div class="small">Special: täglich ein Thema (Murder Monday … Super Sonntag)</div>
        <div style="height:8px"></div>
        <div><button class="btn" id="openSpecial">Heute: Special anzeigen</button></div>
        <div style="height:8px"></div>
        <div class="small">TMDB Key (für Poster & Laufzeiten):</div>
        <input id="tmdbKey" placeholder="TMDB Key" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" />
        <div style="height:8px"></div>
        <div class="small">Hinweis: Öffne per http-server falls TMDB-Anfragen wegen CORS nicht funktionieren.</div>
      </div>
    </aside>
  </div>

  <div class="footer-note">Programm bleibt gleich bis du 'Neu generieren' klickst. Blacklist-Block ist fix um 20:00.</div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-poster" id="modalPoster"></div>
      <div class="modal-body">
        <div class="modal-title" id="modalTitle">Titel</div>
        <div class="small" id="modalMeta">Typ · Anbieter</div>
        <div class="modal-desc" id="modalDesc">Beschreibung …</div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>
    <div style="text-align:right;margin-top:8px"><button class="btn" id="modalClose">Schließen</button></div>
  </div>
</div>

<script>
/* ---------- Config ---------- */
const START_MIN = 16 * 60;  // 16:00
const END_MIN = 26 * 60;    // 02:00 as 26:00
const scheduleKeyPrefix = 'tv_v3_schedule_';
const tmdbStorageKey = 'tv_v3_tmdb_key';
const tmdbPresetKey = '057d0480e196b9c9a9e4ebaa77c15c12'; // vorbefüllt
const usedLimitPerDay = 1; // same title max once per day
const BLACKLIST_START_MIN = 20 * 60; // 20:00 fixed

/* ---------- Provider search helpers ---------- */
const providers = {
  netflix: q => 'https://www.netflix.com/de/search?q=' + encodeURIComponent(q),
  prime: q => 'https://www.amazon.de/s?k=' + encodeURIComponent(q),
  sky: q => 'https://www.wowtv.de/suche?query=' + encodeURIComponent(q),
  ard: q => 'https://www.ardmediathek.de/suche/?q=' + encodeURIComponent(q),
  zdf: q => 'https://www.zdf.de/suche?q=' + encodeURIComponent(q),
  arte: q => 'https://www.arte.tv/de/suche/?q=' + encodeURIComponent(q)
};

/* ---------- LARGE, REALISTIC CONTENT POOLS ---------- */
/* Pools were curated to reflect titles commonly available on Netflix DE, Prime DE, Sky/WOW, ARD/ZDF/ARTE.
   This is a large but still manageable list — I kept it focused on realistic streaming hits in DE. */

const pools = {
  drama: [
  "The Blacklist","Das Boot","The Sopranos","Breaking Bad","Better Call Saul","Ozark","Mindhunter","True Detective",
  "Narcos","Broadchurch","The Crown","Fargo","Gomorrah","Peaky Blinders","Homeland","Line of Duty","Sons of Anarchy",
  "Dark","Babylon Berlin","Marcella","The Night Of","Borgen","Unorthodox","Trapped","Killing Eve","Bosch","Jack Ryan",
  "The Americans","Hannibal","The Wire","The Shield","Luther","River","Top of the Lake","The Fall","Miss Sherlock"
  ],
  klassiker: [
  "Der Pate","Der Pate II","Scarface","Pulp Fiction","Spiel mir das Lied vom Tod","Heat","Goodfellas","Taxi Driver",
  "Casablanca","Citizen Kane","Apocalypse Now","The Godfather Part III","Chinatown","Once Upon a Time in America",
  "The Graduate","Vertigo","Raging Bull","The Deer Hunter","The Third Man","Bonnie and Clyde","A Clockwork Orange",
  "Reservoir Dogs","The Bridge on the River Kwai","Dr. Strangelove","Blade Runner","Sunset Blvd"
  ],
  comedy: [
  "Family Guy","South Park","Futurama","BoJack Horseman","How I Met Your Mother","The Office (US)","Arrested Development",
  "Brooklyn Nine-Nine","Parks and Recreation","Seinfeld","Curb Your Enthusiasm","The Simpsons","Rick and Morty",
  "American Dad","The IT Crowd","30 Rock","Community","The Marvelous Mrs. Maisel","Monty Python's Flying Circus",
  "The Naked Gun","This Is the End","The Boys (comedy-ish)", "It's Always Sunny in Philadelphia","Superbad","Hot Fuzz"
  ],
  doku: [
  "Terra X","Die Deutschen","Planet Earth","Blue Planet","Our Planet","ZDF History","BBC Horizon","Cosmos",
  "The Last Dance","Making a Murderer","Inside Job","The Keepers","Ken Burns: The Civil War","The Vietnam War",
  "Wildlife Specials","Anthony Bourdain: Parts Unknown","Chef's Table","Jiro Dreams of Sushi","Citizenfour"
  ],
  kult: [
  "Pulp Fiction","Baby Driver","Sicario","Collateral","Drive","Mad Max: Fury Road","Blade Runner","Inception",
  "The Dark Knight","Fight Club","Interstellar","The Matrix","Se7en","No Country for Old Men","Oldboy","Memento",
  "Inglourious Basterds","The Revenant","The Departed","Shutter Island","Heat","The Bourne Identity","John Wick"
  ]
};

/* Enrich pools with more realistic streaming hits (extend to ~400 combined) */
const moreTitles = [
  "The Irishman","Joker","La La Land","Whiplash","Spotlight","Moonlight","Parasite","The Social Network","Good Will Hunting",
  "12 Years a Slave","The King's Speech","Manchester by the Sea","Roma","Her","The Grand Budapest Hotel","The Truman Show",
  "Requiem for a Dream","The Prestige","The Big Lebowski","Donnie Darko","Blade","The Exorcist","Alien","Aliens",
  "The Shining","The Terminator","Terminator 2","Mad Max 2: The Road Warrior","The Hobbit: An Unexpected Journey",
  "Harry Potter and the Sorcerer's Stone","Harry Potter and the Chamber of Secrets","Harry Potter and the Prisoner of Azkaban",
  "The Lord of the Rings: The Two Towers","The Lord of the Rings: The Return of the King","The Fellowship of the Ring",
  "Star Wars: A New Hope","Star Wars: The Empire Strikes Back","Star Wars: Return of the Jedi","Rogue One",
  "Guardians of the Galaxy","The Avengers","Avengers: Endgame","Captain Marvel","Black Panther","Thor: Ragnarok",
  "Wonder Woman","Logan","Deadpool","Deadpool 2","The Hunger Games","Divergent","The Martian","Gravity","Arrival",
  "Blade Runner 2049","Hereditary","Get Out","Us","Midsommar","The Witch","The Lighthouse","Portrait of a Lady on Fire",
  "Brooklyn","Lady Bird","Call Me by Your Name","The Favourite","Three Billboards Outside Ebbing, Missouri",
  "The Handmaid's Tale","Killing Eve","The Expanse","Love, Death & Robots","Black Mirror","Westworld","The Boys",
  "Daredevil","Jessica Jones","Luke Cage","The Punisher","Watchmen","The Man in the High Castle","House of Cards",
  "The Haunting of Hill House","The Haunting of Bly Manor","Stranger Things","Narcos: Mexico","Elite","Money Heist",
  "Lupin","Dark Desire","Elite Short Stories","The Queen's Gambit","You","Mindhunter","The Outsider","The Undoing",
  "Sherlock","Doctor Who","Broadchurch","Marcella","Line of Duty","The Sinner","True Detective","Sharp Objects",
  "Mr. Robot","Black Mirror","Fargo (TV)","The Leftovers","Homeland","24","Prison Break","The Good Wife","Scandal",
  "How to Get Away with Murder","The Good Place","Schitt's Creek","Fleabag","Killing Eve","The Office (UK)",
  "Peep Show","Gavin & Stacey","Derry Girls","Fawlty Towers","The Young Pope","The New Pope","Rome","Spartacus",
  "Band of Brothers","The Pacific","Chernobyl","When They See Us","Unbelievable","Broadchurch","Happy Valley",
  "Top of the Lake","Miss Fisher's Murder Mysteries","Inspector Morse","Midsomer Murders","Poirot","Agatha Christie's Marple"
];

/* merge moreTitles into pools evenly */
(function expandPools(){
  const categories = Object.keys(pools);
  let i = 0;
  moreTitles.forEach(t=>{
    pools[categories[i % categories.length]].push(t);
    i++;
  });
})();

/* poster metadata cache */
let posterCache = {}; // title -> {poster,desc,year,duration}

/* ---------- Helpers ---------- */
function minutesToHHMM(mins){
  const m = mins % (24*60);
  const h = Math.floor(m/60);
  const mm = m % 60;
  return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
}
function roundUpTo10(n){ return Math.ceil(n/10)*10; }
function todayKey(){ const d=new Date(); return scheduleKeyPrefix + d.getFullYear() + '_' + (d.getMonth()+1) + '_' + d.getDate(); }
function chooseNoRepeat(pool, used){
  const candidates = pool.filter(t => (used[t]||0) < usedLimitPerDay);
  if(candidates.length === 0) return pool[Math.floor(Math.random()*pool.length)];
  return candidates[Math.floor(Math.random()*candidates.length)];
}

/* ---------- TMDB fetching (duration & poster) ---------- */
async function fetchTMDBInfo(title){
  try {
    const key = localStorage.getItem(tmdbStorageKey) || tmdbPresetKey || '';
    if(!key) return null;
    const q = encodeURIComponent(title);
    const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${key}&language=de-DE&query=${q}&page=1&include_adult=false`);
    if(!res.ok) return null;
    const data = await res.json();
    if(!data.results || data.results.length===0) return null;
    // pick best match preferring exact, then movie/tv
    let item = data.results.find(r => ((r.title && r.title.toLowerCase() === title.toLowerCase()) || (r.name && r.name.toLowerCase() === title.toLowerCase()))) || data.results.find(r => r.media_type === 'movie' || r.media_type === 'tv') || data.results[0];
    if(!item) return null;
    const posterPath = item.poster_path || item.backdrop_path || null;
    const posterUrl = posterPath ? 'https://image.tmdb.org/t/p/w500' + posterPath : null;
    const desc = item.overview || '';
    const year = item.release_date || item.first_air_date || '';
    let duration = null;
    // fetch details for runtime when possible
    if(item.media_type === 'movie' || item.title){
      const m = await fetch(`https://api.themoviedb.org/3/movie/${item.id}?api_key=${key}&language=de-DE`);
      if(m.ok){
        const md = await m.json();
        duration = md.runtime || null;
      }
    }
    if((item.media_type === 'tv' || item.name) && !duration){
      const t = await fetch(`https://api.themoviedb.org/3/tv/${item.id}?api_key=${key}&language=de-DE`);
      if(t.ok){
        const td = await t.json();
        if(td.episode_run_time && td.episode_run_time.length>0) duration = td.episode_run_time[0];
      }
    }
    // fallbacks
    if(!duration){
      const low = title.toLowerCase();
      if(low.includes('season') || low.includes('staffel') || low.includes('episode') || low.includes('series') || low.includes('s01') || low.includes('s02') ) duration = 45;
      else if(pools.doku.some(x=> x.toLowerCase()===title.toLowerCase())) duration = 50;
      else if(pools.comedy.some(x=> x.toLowerCase()===title.toLowerCase())) duration = 25;
      else duration = 110;
    }
    const info = {poster: posterUrl, desc, year, duration};
    posterCache[title] = info;
    return info;
  } catch(e){
    console.warn('TMDB fetch error for', title, e);
    return null;
  }
}

/* ---------- Build dynamic schedule using real durations ---------- */
async function buildScheduleDynamic(){
  // if already cached for today, return it
  const key = todayKey();
  const saved = localStorage.getItem(key);
  if(saved) try { return JSON.parse(saved); } catch(e){ /* rebuild */ }

  const schedule = {rows:{drama:[],klassiker:[],comedy:[],doku:[],kult:[],special:[]}, ticks:[]};
  const used = {};

  // prepare special pool for today
  const wd = new Date().getDay();
  const special = specialThemes[wd] || specialThemes[1];
  const specialPool = Array.from({length:400}, (_,i)=> special.samples[i % special.samples.length]);

  // helper to fill a single row from START_MIN to END_MIN
  async function fillRow(pool, placeBlacklistBlock=false){
    const row = [];
    let tMin = START_MIN;
    let blacklistPlaced = false;

    while(tMin < END_MIN - 5){
      // if drama and blacklist placement time reached and not placed, insert block (3 episodes)
      if(placeBlacklistBlock && !blacklistPlaced && tMin >= BLACKLIST_START_MIN){
        const blTitle = 'The Blacklist';
        // fetch duration for an episode (if tv runtime exists)
        let info = posterCache[blTitle] || await fetchTMDBInfo(blTitle);
        let epDur = info && info.duration ? info.duration : 45;
        epDur = Math.max(10, Math.round(epDur));
        const durR = roundUpTo10(epDur);
        for(let b=0;b<3 && tMin < END_MIN; b++){
          // ensure not overflow beyond END_MIN greatly
          if(tMin + durR > END_MIN && b>0) break;
          row.push({title: blTitle, start: tMin, duration: durR, end: tMin + durR});
          used[blTitle] = (used[blTitle]||0) + 1;
          tMin += durR;
        }
        blacklistPlaced = true;
        continue;
      }

      // pick title avoiding repeats
      const title = chooseNoRepeat(pool, used);
      // get duration (from cache or TMDB)
      let info = posterCache[title];
      if(!info) info = await fetchTMDBInfo(title);
      let dur = info && info.duration ? info.duration : (pool===pools.comedy ? 25 : (pool===pools.doku ? 50 : (pool===pools.klassiker ? 120 : 45)));
      dur = Math.max(8, Math.min(240, Math.round(dur)));
      const durR = roundUpTo10(dur);

      // if does not fit, try a few alternatives
      if(tMin + durR > END_MIN){
        let placed = false;
        for(let attempt=0; attempt<4; attempt++){
          const alt = chooseNoRepeat(pool, used);
          if(alt===title) continue;
          let ainfo = posterCache[alt] || await fetchTMDBInfo(alt);
          let adur = ainfo && ainfo.duration ? ainfo.duration : 45;
          adur = Math.max(8, Math.min(240, Math.round(adur)));
          const adurR = roundUpTo10(adur);
          if(tMin + adurR <= END_MIN){
            row.push({title: alt, start: tMin, duration: adurR, end: tMin + adurR});
            used[alt] = (used[alt]||0) + 1;
            tMin += adurR;
            placed = true;
            break;
          }
        }
        if(!placed) break; // no fit found
      } else {
        row.push({title, start: tMin, duration: durR, end: tMin + durR});
        used[title] = (used[title]||0) + 1;
        tMin += durR;
      }
    }
    return row;
  }

  // Build each row (drama with fixed blacklist block)
  schedule.rows.drama = await fillRow(pools.drama, true);
  schedule.rows.klassiker = await fillRow(pools.klassiker, false);
  schedule.rows.comedy = await fillRow(pools.comedy, false);
  schedule.rows.doku = await fillRow(pools.doku, false);
  schedule.rows.kult = await fillRow(pools.kult, false);
  schedule.rows.special = await fillRow(specialPool, false);

  // timeline ticks every 30 minutes between START and END
  const ticks = [];
  for(let m = START_MIN; m <= END_MIN; m += 30) ticks.push(minutesToHHMM(m));
  schedule.ticks = ticks;

  // cache schedule
  localStorage.setItem(key, JSON.stringify(schedule));
  return schedule;
}

/* ---------- Rendering ---------- */
const timelineEl = document.getElementById('timeline');
const rowsEl = document.getElementById('rows');
const modal = document.getElementById('modal');
const modalPoster = document.getElementById('modalPoster');
const modalTitle = document.getElementById('modalTitle');
const modalMeta = document.getElementById('modalMeta');
const modalDesc = document.getElementById('modalDesc');
const modalActions = document.getElementById('modalActions');

function providerHint(title){
  const lower = title.toLowerCase();
  if(['bojack','das boot','futurama','rick and morty','witcher','lord of the rings','better call saul','ozark','narcos','breaking bad'].some(k=>lower.includes(k))) return 'Netflix DE';
  if(['family guy','south park','pulp','baby','scarface','goodfellas','der pate','heat','inception','drive','mad max','blade runner','john wick','james bond'].some(k=>lower.includes(k))) return 'Prime / WOW';
  if(['terra x','die deutschen','ard','zdf','arte','making a murderer','the last dance','planet earth'].some(k=>lower.includes(k))) return 'ARD / ZDF / ARTE';
  if(lower.includes('blacklist') || lower.includes('sopranos')) return 'Sky / Prime (prüfen)';
  return 'Provider prüfen';
}

function renderTimeline(ticks){
  timelineEl.innerHTML = '';
  ticks.forEach(t=>{
    const d = document.createElement('div'); d.className='timecell'; d.textContent = t; timelineEl.appendChild(d);
  });
}

function renderRows(schedule){
  rowsEl.innerHTML = '';
  const mapping = [
    {key:'drama', name:'Drama'},
    {key:'klassiker', name:'Kino Klassiker'},
    {key:'comedy', name:'Comedy & Animation'},
    {key:'doku', name:'Doku & Geschichte'},
    {key:'kult', name:'Sky/Prime Kult-Hits'},
    {key:'special', name:'Special — ' + (specialThemes[new Date().getDay()]?.name || 'Themen')}
  ];
  mapping.forEach(rowInfo=>{
    const wrap = document.createElement('div'); wrap.className='row';
    const header = document.createElement('div'); header.className='row-header';
    const title = document.createElement('div'); title.className='row-title'; title.textContent = rowInfo.name;
    header.appendChild(title); wrap.appendChild(header);
    const sc = document.createElement('div'); sc.className='row-scroll';
    const items = schedule.rows[rowInfo.key] || [];
    items.forEach(it=>{
      const card = document.createElement('div'); card.className='card';
      const poster = document.createElement('div'); poster.className='poster';
      const pc = posterCache[it.title] && posterCache[it.title].poster ? posterCache[it.title].poster : '';
      if(pc) poster.style.backgroundImage = `url(${pc})`; else poster.textContent = '';
      const meta = document.createElement('div'); meta.className='meta';
      const tdiv = document.createElement('div');
      tdiv.innerHTML = `<div class="titleSmall">${it.title}</div><div class="provider">${providerHint(it.title)}</div><div style="font-size:12px;color:var(--muted)">${minutesToHHMM(it.start)} — ${minutesToHHMM(it.end)} (${it.duration} min)</div>`;
      meta.appendChild(tdiv);
      card.appendChild(poster);
      card.appendChild(meta);
      card.onclick = ()=> openModal(it.title);
      sc.appendChild(card);
    });
    wrap.appendChild(sc);
    rowsEl.appendChild(wrap);
  });
}

/* ---------- Modal & actions ---------- */
async function openModal(title){
  modal.classList.add('open');
  modalTitle.textContent = title;
  modalMeta.textContent = providerHint(title);
  modalDesc.textContent = 'Lade Informationen ...';
  modalPoster.style.backgroundImage = '';
  modalActions.innerHTML = '';

  let info = posterCache[title];
  if(!info) info = await fetchTMDBInfo(title);
  if(info){
    if(info.poster) modalPoster.style.backgroundImage = `url(${info.poster})`;
    modalDesc.textContent = info.desc || 'Keine Beschreibung verfügbar.';
    modalMeta.textContent = (info.year ? (info.year.split('-')[0] + ' · ') : '') + providerHint(title);
  } else {
    modalDesc.textContent = 'Keine Metadaten gefunden (TMDB-Key fehlt oder kein Treffer).';
  }

  const btns = [
    {name:'Netflix DE',url:providers.netflix(title)},
    {name:'Prime DE',url:providers.prime(title)},
    {name:'WOW / Sky',url:providers.sky(title)},
    {name:'ARD',url:providers.ard(title)},
    {name:'ZDF',url:providers.zdf(title)},
    {name:'ARTE',url:providers.arte(title)}
  ];
  btns.forEach(b=>{
    const el = document.createElement('button'); el.className='btn'; el.textContent=b.name;
    el.onclick = (e)=>{ e.stopPropagation(); window.open(b.url,'_blank'); };
    modalActions.appendChild(el);
  });
}
document.getElementById('modalClose').onclick = ()=> modal.classList.remove('open');

/* ---------- Settings ---------- */
document.getElementById('settingsBtn').onclick = () => {
  document.getElementById('tmdbKey').value = localStorage.getItem(tmdbStorageKey) || tmdbPresetKey || '';
  document.getElementById('settings').classList.add('open');
};
document.getElementById('saveSettings')?.addEventListener('click', () => {
  const k = document.getElementById('tmdbKey').value.trim();
  if(k) localStorage.setItem(tmdbStorageKey, k); else localStorage.removeItem(tmdbStorageKey);
  document.getElementById('settings').classList.remove('open');
  alert('Einstellungen gespeichert. Poster/Laufzeiten werden bei Bedarf geladen.');
});
document.getElementById('settings').addEventListener('click', (e)=> { if(e.target === document.getElementById('settings')) document.getElementById('settings').classList.remove('open'); });

/* ---------- Top controls ---------- */
document.getElementById('regen').onclick = async () => {
  localStorage.removeItem(todayKey());
  await init();
};
document.getElementById('export').onclick = () => {
  const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'mein_tv_programm_v3.html'; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('openSpecial').onclick = () => {
  const rows = document.querySelectorAll('.row-title');
  rows.forEach(r=>{ if(r.textContent.toLowerCase().includes('special')) r.scrollIntoView({behavior:'smooth',block:'center'}); });
};

/* ---------- Init ---------- */
async function init(){
  try{
    posterCache = posterCache || {};
    const schedule = await buildScheduleDynamic();
    renderTimeline(schedule.ticks);
    renderRows(schedule);
    // background prefetch of posters (best-effort)
    const all = new Set();
    Object.values(schedule.rows).forEach(arr => arr.forEach(it => all.add(it.title)));
    for(const t of all){
      if(!posterCache[t]) fetchTMDBInfo(t).catch(()=>null);
    }
  }catch(e){
    console.error('Init error', e);
    alert('Fehler beim Erzeugen des Programms. Wenn du lokal per file:// arbeitest, starte bitte einen kleinen http-server oder nutze GitHub Pages.');
  }
}
init();
</script>
</body>
</html>